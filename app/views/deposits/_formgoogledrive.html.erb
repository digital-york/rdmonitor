<div id="jstree_div" title="Select files from Google Drive">Loading Google Drive - please wait...</div>

<div id="jstree_status"></div>

<script>
  $(function () { 
    $('#jstree_div').jstree({
      "plugins" : ["checkbox", "changed"],
      'core': {
        'data': {
          'url' : function (node) {
            return "/googledrive.json?folder=" + (node.id === "#" ? "root" : node.id)
          },
          'data' : function (node) {

          }
        }
      },
      'checkbox': {
        //tie_selection: false
        three_state: false,
        //whole_node: false
      }
    }); 
  }); 
  $('#jstree_div').on("changed.jstree", function (e, data) {
    //console.log(data.selected);
    //console.log(data.instance.get_node(data.selected[0]));
    //console.log(data.instance.get_path(data.selected[0], "/"));
    //console.log(data.instance.get_top_selected(false));
    // if a folder is selected/checked, open it and automatically select all of its contents (recursively if there are subfolders)  
    if (data.instance.is_parent(data.changed.selected[0])) {
      data.instance.open_node(data.changed.selected[0], function (d2) {
        // for each child in the selected and opened node, select it
        //console.log(d2);
        for (var i = 0; i < d2.children.length; i++) {
          data.instance.select_node(data.instance.get_node(d2.children[i]));
        }
      });
    }
    // if a folder is deselected/unchecked, automatically deselect/uncheck all of its contents (recursively if there are subfolders)
    if (data.instance.is_parent(data.changed.deselected[0])) {
      var node = data.instance.get_node(data.changed.deselected[0]);
      for (var k = 0; k < node.children.length; k++) {
        data.instance.deselect_node(node.children[k]);
      }
    }
    //console.log(data.changed);
    // update the "status" message of the dialog
    $("#jstree_status").html(data.selected.length + " files selected");
  });
  $('#jstree_div').on("select_node.jstree", function (e, data) {
    //console.log(data.node);
  });
</script>

<script>
$( function() {
  dialog = $( "#jstree_div" ).dialog({
    autoOpen: false,
    resizable: true,
    height: 500,
    width: 600,
    modal: true,
    buttons: {
      "OK": function() {
        $( this ).dialog( "close" );
      },
      Cancel: function() {
        $( this ).dialog( "close" );
      }
    }
  });
  $("#jstree_status").appendTo(".ui-dialog-buttonpane");
  $( "#google-drive-btn2" ).button().on( "click", function() {
    dialog.dialog( "open" );
  });
});
</script>

